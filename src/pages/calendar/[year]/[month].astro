---
import Container from "@/layouts/Container.astro";
import type { GetStaticPaths } from "astro";
import {
  addMonths,
  compareAsc,
  formatDate,
  getDate,
  getYear,
  getMonth,
  differenceInMonths,
  isAfter,
} from "date-fns";
import { generateCalendar } from "@/lib/calendar";
import { IoChevronForward } from "react-icons/io5";
import { getCollection } from "astro:content";
import _ from "lodash";
import { Breadcrumbs } from "astro-breadcrumbs";
import { PLAY_CRICKET_1XI_ID } from "astro:env/server";
import { PLAY_CRICKET_2XI_ID } from "astro:env/server";
import { CalendarAgenda } from "@/components/calendar/CalendarAgenda";
import type { CalendarItem } from "@/components/calendar/CalendarAgenda";

export const getStaticPaths = (async () => {
  function categorise(
    item: { type: string; team?: { id: string; name: string } },
  ): CalendarItem["category"] {
    if (item.type === "event") return "event";
    const team = item.team;
    if (!team) return "event";
    if (team.id === PLAY_CRICKET_1XI_ID) return "1xi";
    if (team.id === PLAY_CRICKET_2XI_ID) return "2xi";
    if (/midweek/i.test(team.name)) return "mid";
    if (/under|junior|colts|\bU\d{2}\b/i.test(team.name)) return "jun";
    return "1xi"; // fallback for unknown teams
  }

  function buildScoreDescription(
    innings: Array<{
      runs: number;
      wickets: number;
      allOut: boolean;
      declared: boolean;
    }>,
  ): string {
    if (!innings || innings.length === 0) return "";
    return innings
      .map((inn) => {
        const wicketStr = inn.allOut ? "" : `/${inn.wickets}`;
        const declStr = inn.declared ? "d" : "";
        return `${inn.runs}${wicketStr}${declStr}`;
      })
      .join(" â€“ ");
  }

  const calendarItems = await getCollection("calendarItem");

  const teamOrder: Record<string, number> = {
    [PLAY_CRICKET_1XI_ID]: 2,
    [PLAY_CRICKET_2XI_ID]: 1,
  };

  const calendarItemGroups = _.groupBy(
    calendarItems.sort(({ data: g1 }, { data: g2 }) => {
      const g1D = getDate(g1.when);
      const g2D = getDate(g2.when);

      if (g1D === g2D) {
        if (g1.type === "game" && g2.type === "game") {
          const t1 = teamOrder[g1.team.id] ?? 0;
          const t2 = teamOrder[g2.team.id] ?? 0;

          return t2 - t1;
        }

        return g1.type === "game" ? 1 : -1;
      }

      return compareAsc(g1.when, g2.when);
    }),
    (item) => `${getYear(item.data.when)}-${getMonth(item.data.when)}`,
  );

  const now = new Date();
  const calendarStart = new Date("2024-01-01");
  const historicalMonthCount = differenceInMonths(now, calendarStart) + 1;
  const past12Months = Array.from(Array(historicalMonthCount), (_, i) =>
    addMonths(now, -i),
  ).reverse();
  const next12Months = Array.from(Array(12), (_, i) => addMonths(now, i + 1));

  const paths = [...past12Months, ...next12Months].map((date, i, arr) => {
    const prevDate = addMonths(date, -1);
    const nextDate = addMonths(date, 1);
    const rawItems = calendarItemGroups[`${getYear(date)}-${getMonth(date)}`] ?? [];

    const items: CalendarItem[] = rawItems
      .filter((entry) => entry.data.when != null)
      .map((entry) => {
      const d = entry.data;
      const when = d.when as Date;
      const cat = categorise(d);

      if (d.type === "game") {
        return {
          id: entry.id,
          type: "game" as const,
          category: cat,
          when: when.toISOString(),
          home: d.home,
          teamName: d.team.name,
          oppositionClub: d.opposition.club.name,
          oppositionTeam: d.opposition.team.name,
          leagueName: d.league.name,
          competitionName: d.competition.name,
          sponsorName: d.sponsor?.name,
          sponsorCta: !d.sponsor && isAfter(when, now),
          outcome: d.result?.outcome ?? null,
          scoreDescription: d.result?.innings
            ? buildScoreDescription(d.result.innings)
            : undefined,
        };
      }

      // Event
      return {
        id: entry.id,
        type: "event" as const,
        category: "event" as const,
        when: when.toISOString(),
        eventName: d.name,
        eventDescription:
          typeof d.description === "string" ? d.description : undefined,
      };
    });

    const calendar = generateCalendar(date, rawItems);
    const calendarDays = calendar.map((day) => ({
      date: day.date.toISOString(),
      isExtra: day.isExtra,
      itemCount: day.items.length,
    }));

    const won = items.filter((i) => i.outcome === "W").length;
    const lost = items.filter((i) => i.outcome === "L").length;
    const upcoming = items.filter(
      (i) => i.type === "game" && !i.outcome,
    ).length;

    const props = {
      year: formatDate(date, "yyyy"),
      month: formatDate(date, "MMMM"),
      monthNumber: getMonth(date),
      items,
      calendarDays,
      stats: { won, lost, upcoming },
      previous:
        i === 0
          ? undefined
          : `/calendar/${formatDate(prevDate, "yyyy").toLocaleLowerCase()}/${formatDate(prevDate, "MMMM").toLocaleLowerCase()}`,
      next:
        i === arr.length - 1
          ? undefined
          : `/calendar/${formatDate(nextDate, "yyyy").toLocaleLowerCase()}/${formatDate(nextDate, "MMMM").toLocaleLowerCase()}`,
    };

    return {
      params: {
        year: props.year.toLocaleLowerCase(),
        month: props.month.toLocaleLowerCase(),
      },
      props,
    };
  });

  return paths;
}) satisfies GetStaticPaths;

const { year, month, monthNumber, items, calendarDays, stats, previous, next } = Astro.props;
---

<Container title="Calendar">
  <div
    class="text-h4 mb-4 [&_ol]:flex [&_ol]:items-center [&_ol]:gap-2 [&_ol>li]:flex [&_ol>li]:items-center [&_ol>li]:gap-2"
    slot="breadcrumbs"
  >
    <Breadcrumbs
      linkTextFormat="capitalized"
      crumbs={[
        {
          text: "Calendar",
          href: "#",
        },
        {
          text: `${month} ${year}`,
          href: "#",
        },
      ]}
    >
      <IoChevronForward slot="separator" />
    </Breadcrumbs>
  </div>

  <CalendarAgenda
    client:load
    items={items}
    year={year}
    month={month}
    monthNumber={monthNumber}
    previous={previous}
    next={next}
    stats={stats}
    calendarDays={calendarDays}
  />
</Container>
