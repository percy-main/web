---
import type { GetStaticPathsResult } from "astro";
import { getCollection } from "astro:content";
import Container from "@/layouts/Container.astro";
import { RichText } from "@/components/RichText";
import LDJson from "@/components/LDJson.astro";
import dbsChecked from "@/components/dbs.png";
import { Picture } from "astro:assets";
import { PlayerSponsor } from "@/components/PlayerSponsor";
import PlayerStatsDeferred from "@/components/PlayerStatsDeferred.astro";
import { Breadcrumbs } from "astro-breadcrumbs";
import { IoChevronForward } from "react-icons/io5";

export async function getStaticPaths() {
  const people = await getCollection("person");

  return people.map((person) => ({
    params: { slug: person.data.slug },
    props: { person },
  })) satisfies GetStaticPathsResult;
}

const games = await getCollection("game");

const {
  person: { id: contentfulEntryId, data: person },
} = Astro.props;
const { pathname } = Astro.url;
const pageData = Object.entries(person.pageData);

---

<LDJson
  slot="ldjson"
  content={{
    "@type": "Person",
    name: person.name,
    image: person.photo?.url,
  }}
/>

<Container title={person.name}>
  <div
    slot="breadcrumbs"
    class="text-h4 mb-4 [&_ol]:flex [&_ol]:items-center [&_ol]:gap-2 [&_ol>li]:flex [&_ol>li]:items-center [&_ol>li]:gap-2"
  >
    <Breadcrumbs
      linkTextFormat="capitalized"
      customizeListElements={[{ index: 0, remove: true }]}
      customizeLinks={[{ index: 1, text: "People" }]}
    >
      <IoChevronForward slot="separator" />
    </Breadcrumbs>
  </div>
  <div class="flex flex-col gap-6 md:flex-row">
    <div class="flex-1">
      <div
        class="mb-4 flex flex-col items-center justify-between gap-4 md:flex-row"
      >
        <div class="flex flex-col items-center justify-start gap-4 md:flex-row">
          {
            person.photo && (
              <img
                class={`mb-0 max-h-48 rounded-full`}
                src={person.photo.url}
                alt={person.photo.title}
                width={132}
                height={132}
              />
            )
          }
        </div>
        {
          person.isDBSChecked && (
            <Picture
              src={dbsChecked}
              formats={["avif", "webp"]}
              alt="DBS Checked"
              height={64}
            />
          )
        }
      </div>

      {
        person.bio && (
          <section>
            <RichText
              client:load
              document={person.bio}
              page={pathname}
              games={games.filter((g) => g.data.type === "game").map((g) => g.data)}
            />
          </section>
        )
      }

      {
        pageData.length > 0 && (
          <section>
            <h5>Club Roles</h5>
            <ul>
              {pageData.map(([slug, role]) => (
                <li>
                  <a
                    class="text-sm text-blue-900 underline"
                    href={
                      slug.startsWith("page$")
                        ? slug.substring("page$".length)
                        : slug
                    }
                  >
                    {role}
                  </a>
                </li>
              ))}
            </ul>
          </section>
        )
      }
    </div>

    <aside class="w-full shrink-0 md:w-64">
      <PlayerSponsor
        client:load
        contentfulEntryId={contentfulEntryId}
        playerSlug={person.slug}
      />
    </aside>
  </div>

  <PlayerStatsDeferred server:defer contentfulEntryId={contentfulEntryId}>
    <div slot="fallback" class="mt-8">
      <div class="h-6 w-40 animate-pulse rounded bg-gray-200"></div>
      <div class="mt-3 grid grid-cols-2 gap-3 sm:grid-cols-3 md:grid-cols-5">
        {Array.from({ length: 5 }).map(() => (
          <div class="rounded-lg border border-gray-200 bg-gray-50 px-3 py-2">
            <div class="mx-auto h-6 w-10 animate-pulse rounded bg-gray-200"></div>
            <div class="mx-auto mt-1 h-3 w-16 animate-pulse rounded bg-gray-200"></div>
          </div>
        ))}
      </div>
    </div>
  </PlayerStatsDeferred>
</Container>
