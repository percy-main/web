---
import { getCollection } from "astro:content";
import Base from "@/layouts/Base.astro";
import ArticlePreview from "@/components/ArticlePreview.astro";
import CalendarStripCard from "@/components/CalendarStripCard.astro";
import SportCard from "@/components/SportCard.astro";
import { compareDesc, compareAsc, isAfter, isSameDay } from "date-fns";
import Hero from "@/components/Hero/Hero.astro";
import { LiveScoreWidget } from "@/components/LiveScoreWidget";
import LDJson from "../components/LDJson.astro";
import { PLAY_CRICKET_1XI_ID, PLAY_CRICKET_2XI_ID } from "astro:env/server";
import { paymentData } from "@/lib/payments/config";

const news = await getCollection("news");
const top5 = news
  .sort(({ data: g1 }, { data: g2 }) => compareDesc(g1.when, g2.when))
  .slice(0, 5);

const calendarItems = await getCollection("calendarItem");

const teamOrder: Record<string, number> = {
  [PLAY_CRICKET_1XI_ID]: 2,
  [PLAY_CRICKET_2XI_ID]: 1,
};

const next5calendarItems = calendarItems
  .sort(({ data: g1 }, { data: g2 }) => {
    if (isSameDay(g1.when, g2.when)) {
      if (g1.type === "game" && g2.type === "game") {
        const t1 = teamOrder[g1.team.id] ?? 0;
        const t2 = teamOrder[g2.team.id] ?? 0;

        return t2 - t1;
      }

      return g1.type === "game" ? 1 : -1;
    }

    return compareAsc(g1.when, g2.when);
  })
  .filter(({ data }) => isAfter(data.when, new Date()))
  .slice(0, 5);

const donateUrl = `/purchase/${paymentData.prices.donation}`;
---

<Base
  title="Home"
  description="Percy Main Community Sports Club supports community sports in Percy Main and surrounding areas."
>
  <LDJson
    slot="ldjson"
    content={{
      "@type": "WebSite",
      name: "Percy Main Community Sports Club",
      url: "https://www.percymain.org",
    }}
  />

  <!-- 1. Hero -->
  <Hero />

  <!-- 1b. Live Scores (renders nothing if no matches today) -->
  <LiveScoreWidget client:load />

  <!-- 2. Calendar Strip -->
  {
    next5calendarItems.length > 0 && (
      <section class="bg-white py-10">
        <div class="container">
          <h3 class="text-h4 mb-6 text-center">What's Coming Up Soon</h3>
          <div class="flex snap-x gap-4 overflow-x-auto pb-2 md:justify-center md:overflow-x-visible">
            {next5calendarItems.map((calendarItem) => (
              <CalendarStripCard id={calendarItem.id} item={calendarItem.data} />
            ))}
          </div>
        </div>
      </section>
    )
  }

  <!-- 3. Featured News -->
  {
    top5.length > 0 && (
      <section class="py-10">
        <div class="container">
          <h3 class="text-h4 mb-6 text-center">Latest News</h3>

          {/* Top row: 2 articles */}
          <div class="grid gap-6 md:grid-cols-2">
            {top5.slice(0, 2).map((article) => (
              <div class="rounded-lg bg-white p-6 shadow-sm">
                <ArticlePreview {...article.data} />
              </div>
            ))}
          </div>

          {/* Bottom row: up to 3 articles */}
          {top5.length > 2 && (
            <div class="mt-6 grid gap-6 md:grid-cols-3">
              {top5.slice(2, 5).map((article) => (
                <div class="rounded-lg bg-white p-6 shadow-sm">
                  <ArticlePreview {...article.data} />
                </div>
              ))}
            </div>
          )}

          <div class="mt-8 text-center">
            <a
              href="/news/1"
              class="text-sm font-medium text-primary transition hover:text-primary-light"
            >
              View all news &rarr;
            </a>
          </div>
        </div>
      </section>
    )
  }

  <!-- 4. Sport Identity -->
  <section class="bg-primary/5 py-12">
    <div class="container">
      <h3 class="text-h4 mb-8 text-center">Our Sports</h3>
      <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-4">
        <SportCard
          name="Cricket"
          description="Men's, women's, and junior teams competing in the Northumberland & Tyneside Cricket League"
          href="/cricket"
          icon="ðŸ"
        />
        <SportCard
          name="Football"
          description="Grassroots football for the local community with Percy Main Amateurs FC"
          href="/football"
          icon="âš½"
        />
        <SportCard
          name="Boxing"
          description="Amateur boxing training and development with BKFC Gym Percy Main"
          href="/boxing"
          icon="ðŸ¥Š"
        />
        <SportCard
          name="Running"
          description="Social running group for all abilities"
          href="/running"
          icon="ðŸƒ"
        />
      </div>
    </div>
  </section>

  <!-- 5. Member Quotes (TODO: uncomment when we have 3 quotes) -->
  <!-- <section class="py-12">
    <div class="container">
      <h3 class="text-h4 mb-8 text-center">From Our Community</h3>
      <div class="grid gap-6 md:grid-cols-3">
        <QuoteCard
          quote="As a newbie I just want to say thanks for the warm welcome and patience as I relearn the ropes. I knew I'd be rusty after not playing for 20 years but I've been surprised at how much technique I had forgotten, so I genuinely appreciate the tips and words of encouragement."
          name="Edward Dickinson"
          role="Club Member"
        />
      </div>
    </div>
  </section> -->

  <!-- 6. Support CTA -->
  <section class="bg-primary py-16">
    <div class="container text-center">
      <h3 class="text-h3 mb-4 text-white">Support Your Local Sports Club</h3>
      <p class="mx-auto mb-8 max-w-2xl text-lg text-white/80">
        As a registered charity, we rely on the generosity of our community to
        maintain our facilities and keep sport accessible for everyone.
      </p>
      <a
        href={donateUrl}
        class="inline-block rounded-lg bg-cta px-8 py-3.5 text-lg font-medium text-white transition-colors hover:bg-cta-dark"
      >
        Donate Now
      </a>
    </div>
  </section>
</Base>
