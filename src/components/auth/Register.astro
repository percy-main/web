---
import { SimpleInput } from "../form/SimpleInput";
import { SearchFilledInput } from "../form/SearchFilledInput";
import LinkButton from "../LinkButton.astro";
---

<section>
  <div class="mx-auto flex flex-col items-center px-6 lg:py-0">
    <div
      class="w-full rounded-lg bg-white shadow-sm sm:max-w-md md:mt-0 md:p-0 dark:border dark:border-gray-700 dark:bg-gray-800"
    >
      <div class="space-y-4 p-6 sm:p-8 md:space-y-6">
        <h1
          class="text-xl leading-tight font-bold tracking-tight text-gray-900 md:text-2xl dark:text-white"
        >
          Register an Account
        </h1>
        <p class="prose">
          Set a password to create your account. This will ensure you don't have
          to fill in these details again. You'll be able to manage your account
          details and subscriptions in your account area.
        </p>
        <form class="space-y-4 md:space-y-6" id="register-form">
          <SearchFilledInput
            id="name"
            type="text"
            label="Name"
            required
            param="name"
            hidden
            client:only="react"
          />
          <SearchFilledInput
            id="email"
            type="email"
            label="Email"
            required
            param="email"
            hidden
            client:only="react"
          />
          <SimpleInput
            id="password"
            type="password"
            label="Password"
            required
          />
          <div id="register-error" class="hidden rounded-lg bg-amber-50 border border-amber-200 p-4 text-sm text-amber-800">
            <p class="font-medium">An account with this email already exists.</p>
            <p class="mt-1">
              You can <a href="/auth/login" class="font-medium underline">sign in here</a>, or
              <a href="/auth/reset-password" class="font-medium underline">reset your password</a> if you've forgotten it.
            </p>
          </div>
          <div id="register-generic-error" class="hidden rounded-lg bg-red-50 border border-red-200 p-4 text-sm text-red-800">
            <p>Something went wrong. Please try again.</p>
          </div>
          <div class="flex items-center justify-between">
            <button
              type="submit"
              class="focus:ring-primary-300 dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800 w-full rounded-lg bg-blue-500 px-5 py-2.5 text-center text-sm font-medium text-white hover:bg-blue-700 focus:ring-4 focus:outline-hidden"
              >Register</button
            >
          </div>
        </form>
      </div>
    </div>

    <p class="prose mt-6">
      If you'd prefer, you can just pay your membership fees without an account.
    </p>
    <LinkButton
      href="/membership/pay"
      class="mt-4"
      text="Pay Without Account"
    />
  </div>
</section>
<section></section>

<script>
  import { authClient } from "@/lib/auth/client";
  const form: HTMLFormElement = document.getElementById(
    "register-form",
  ) as HTMLFormElement;

  form.addEventListener("submit", async (event) => {
    event.preventDefault();

    const errorEl = document.getElementById("register-error")!;
    const genericErrorEl = document.getElementById("register-generic-error")!;
    errorEl.classList.add("hidden");
    genericErrorEl.classList.add("hidden");

    const data = new FormData(event.target as HTMLFormElement);

    const name = data.get("name")?.toString() ?? "";
    const email = data.get("email")?.toString() ?? "";
    const password = data.get("password")?.toString() ?? "";

    const tmp = await authClient.signUp.email({
      name,
      email,
      password,
      callbackURL: "/auth/email-confirmed/",
    });

    if (!tmp.error) {
      window.location.href = "/auth/registered";
    } else if (tmp.error.code === "USER_ALREADY_EXISTS") {
      errorEl.classList.remove("hidden");
    } else {
      genericErrorEl.classList.remove("hidden");
    }
  });
</script>
