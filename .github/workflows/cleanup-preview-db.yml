name: Cleanup Preview Database

on:
  pull_request:
    types: [closed]

permissions: {}

jobs:
  cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Delete preview database branch
        env:
          TURSO_API_TOKEN: ${{ secrets.TURSO_API_TOKEN }}
          TURSO_ORG: percymain
        run: |
          # Netlify sets BRANCH to "pull/<number>/head" for deploy previews,
          # which the migrate plugin sanitises to "pull-<number>-head".
          # Use the PR number directly to match that convention.
          PR_NUMBER="${{ github.event.number }}"
          DB_NAME="preview-pull-${PR_NUMBER}-head"

          echo "Deleting preview database: ${DB_NAME}"

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
            "https://api.turso.tech/v1/organizations/${TURSO_ORG}/databases/${DB_NAME}" \
            -H "Authorization: Bearer ${TURSO_API_TOKEN}")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "Deleted preview database: ${DB_NAME}"
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "Preview database not found (may not have been created): ${DB_NAME}"
          else
            echo "::warning::Unexpected response deleting ${DB_NAME}: HTTP ${HTTP_CODE}"
          fi
